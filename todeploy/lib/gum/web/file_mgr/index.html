<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager</title>
    <link href="logo.png" rel="icon" type="image/png">

    <!-- Bulma CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.4/css/bulma.min.css">

    <!-- Tabler Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css">

    <!-- jsTree CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css">

    <!-- jQuery (required by jsTree) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- jsTree -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>

    <style>
        body
        {
            padding: 20px;
        }

        #fileTree
        {
            margin-top: 20px;
            border: 1px solid #dbdbdb;
            border-radius: 4px;
            padding: 15px;
            background: #fafafa;
            min-height: 500px;
            max-height: 70vh;
            overflow: auto;
        }

        #fileTree .jstree-themeicon
        {
            background-image: none !important;
            width: auto !important;
            height: auto !important;
            line-height: normal !important;
            text-indent: 0 !important;
            background-position: 0 0 !important;
            display: inline-block !important;
            margin-right: 4px; /* Space between icon and text */
        }

        /* Ensure proper font application */
        #fileTree .jstree-anchor > .jstree-themeicon.ti
        {
            font-family: 'tabler-icons' !important;
            speak: never;
            font-style: normal;
            font-weight: normal;
            font-variant: normal;
            text-transform: none;
            line-height: 1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 1.2rem;
        }

        .toolbar
        {
            margin-bottom: 20px;
        }

        .modal-card
        {
            width: 500px;
        }

        #editorContent
        {
            font-family: 'Courier New', monospace;
            min-height: 400px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="toolbar">
            <div class="buttons">
                <button class="button is-info"    title="Upload a file to the server"         onclick="onUploadFile()">
                    <span class="icon" style="font-size: 1.5rem;"><i class="ti ti-upload"></i></span>
                </button>
                <button class="button is-info"    title="Create a new folder at server side"  onclick="onCreateFolder()">
                    <span class="icon" style="font-size: 1.5rem;"><i class="ti ti-folder-plus"></i></span>
                </button>
                <button class="button is-info"    title="Create a new file at server side"    onclick="onCreateFile()">
                    <span class="icon" style="font-size: 1.5rem;"><i class="ti ti-file-plus"></i></span>
                </button>
                <button class="button is-info"    title="Rename highlighted node [F2]"        onclick="onRenameNode()">
                    <span class="icon" style="font-size: 1.5rem;"><i class="ti ti-edit"></i></span>
                </button>
                <button class="button is-info"    title="Show/Edit file contents [Dbl-Click]" onclick="onEditFile()">
                    <span class="icon" style="font-size: 1.5rem;"><i class="ti ti-file-text"></i></span>
                </button>
                <button class="button is-success" title="Refresh (reload) whole tree"         onclick="onRefreshTree()">
                    <span class="icon" style="font-size: 1.5rem;"><i class="ti ti-refresh"></i></span>
                </button>
                <button class="button is-danger"  title="Delete files and folders"            onclick="onDeleteNode()">
                    <span class="icon" style="font-size: 1.5rem;"><i class="ti ti-trash"></i></span>
                </button>
            </div>
        </div>

        <!-- File Tree -->
        <div id="fileTree"></div>

        <!-- Hidden file input for upload -->
        <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)" multiple>
    </div>

    <!-- Modal for Create Folder -->
    <div id="modalCreateFolder" class="modal">
        <div class="modal-background" onclick="closeModal('modalCreateFolder')"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Create Folder</p>
                <button class="delete" onclick="closeModal('modalCreateFolder')"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">Folder Name</label>
                    <div class="control">
                        <input id="folderName" class="input" type="text" placeholder="Enter folder name">
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="createFolder()">Create</button>
            </footer>
        </div>
    </div>

    <!-- Modal for Create File -->
    <div id="modalCreateFile" class="modal">
        <div class="modal-background" onclick="closeModal('modalCreateFile')"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Create File</p>
                <button class="delete" onclick="closeModal('modalCreateFile')"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">File Name</label>
                    <div class="control">
                        <input id="fileName" class="input" type="text" placeholder="Enter file name (e.g., document.txt)">
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="createFile()">Create</button>
            </footer>
        </div>
    </div>



    <!-- Modal for Edit File -->
    <div id="modalEditFile" class="modal">
        <div class="modal-background" onclick="closeModal('modalEditFile')"></div>
        <div class="modal-card" style="width: 800px;">
            <header class="modal-card-head">
                <p class="modal-card-title"><span id="editFileName"></span></p>
                <button class="delete" onclick="closeModal('modalEditFile')"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <div class="control">
                        <textarea id="editorContent" class="textarea"></textarea>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" onclick="saveFile()">Save</button>
            </footer>
        </div>
    </div>

    <!-- Modal for Confirmation -->
    <div id="modalConfirm" class="modal">
        <div class="modal-background" onclick="closeModal('modalConfirm')"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">Confirm Action</p>
                <button class="delete" onclick="closeModal('modalConfirm')"></button>
            </header>
            <section class="modal-card-body">
                <p id="confirmMessage"></p>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" id="confirmYes">Yes</button>
                <button class="button" id="confirmNo" onclick="closeModal('modalConfirm')">No</button>
            </footer>
        </div>
    </div>


    <script>
        // Constants
        const API_FILES = window.location.origin + '/gum/ws/files';
        const API_UPLOAD = window.location.origin + '/gum/upload';
        const aSelected = [];
        const EDITABLE_EXTENSIONS = ['txt', 'json', 'une', 'model', 'html', 'css', 'js', 'java', 'py'];

        // Variables
        let currentEditPath = null;

        //------------------------------------------------------------------------//
        // INITIALIZATION

        $(document).ready( function()
        {
            showNotification('WARN: this tool is for internal use.<br>'+
                             'It is unsafe for public access.', 'is-warning')
            initializeTree();
            loadFileTree();

        // Add keyboard support for modals (Esc to close)
            $(document).on('keydown', function(e)
            {
                if( e.key === 'Escape' )
                {
                    // Close any active modal
                    const $activeModal = $('.modal.is-active');
                    if( $activeModal.length > 0 )
                    {
                        closeModal( $activeModal.attr('id') );
                        e.preventDefault();
                        return false;
                    }
                }
            });
        });

        function initializeTree()
        {
            $('#fileTree').jstree(
            {
                'core': {
                            'data': [],
                            'check_callback': true,
                            'themes': { 'icons': true  }
                        }
            });

            $('#fileTree')
                .on('refresh.jstree', function (e, data)
                {
                    let rootNodeId = data.instance.get_node('#').children[0];

                    if( rootNodeId )
                    {
                        data.instance.select_node(rootNodeId);
                        data.instance.open_node(rootNodeId);
                    }
                })
                .on('select_node.jstree', function( e, data )
                    {
                        aSelected.length = 0;

                        for( let n = 0; n < data.selected.length; n++ )
                            aSelected.push( data.instance.get_node(data.selected[n]) ) ;
                    })
                .on('dblclick.jstree', '.jstree-anchor', function(evt)
                    {
                        if( aSelected.length > 0 )
                            onEditFile();
                    })
                .on('edit.jstree', function(evt, data)
                    {
                        // Store original text when inline editing starts
                        originalRenameText = data.text;
                    })
                .on('rename_node.jstree', function(evt, data)
                    {
                        // Only call server if name actually changed
                        if( data.old !== data.text )
                        {
                            const sOldPath = data.node.original.path;
                            const sParentPath = getParentPath( sOldPath );
                            const sNewPath = sParentPath ? sParentPath + '/' + data.text : data.text;

                            renameNode( sOldPath, sNewPath );
                        }
                    });
        }

        //------------------------------------------------------------------------//
        // API CALLS

        async function loadFileTree()
        {
            try
            {
                const response = await fetchIt( API_FILES, { method: 'GET' });
                const treeData = convertToJsTreeFormat( JSON.parse( response ) );
                const $tree    = $('#fileTree');

                $tree.jstree( true ).settings.core.data = treeData;
                $tree.jstree( true ).refresh();
            }
            catch( error )
            {
                showNotification( 'Error loading file tree: ' + error.message, 'is-danger' );
            }
        }

        async function getFileContent( sFilePath )
        {
            try
            {
                return await fetchIt( API_FILES + '?file=' + encodeURIComponent( sFilePath ));
            }
            catch( error )
            {
                showNotification( 'Error loading file: ' + error.message, 'is-danger' );
                return null;
            }
        }

        async function createResource( sType, sParent, sName, sContent )
        {
            try
            {
                const params = new URLSearchParams({ type: sType, name: sName });

                if( sParent )
                    params.append( 'parent', sParent );

                if( sContent )
                    params.append( 'content', sContent );

                // fetchIt() returns text on success, throws on HTTP error
                await fetchIt( API_FILES + '?' + params.toString(), { method: 'PUT' });

                showNotification( sType.charAt(0).toUpperCase() + sType.slice(1) + ' created successfully', 'is-success' );
                loadFileTree();
            }
            catch( error )
            {
                showNotification( 'Error creating ' + sType + ': ' + error.message, 'is-danger' );
            }
        }

        async function renameResource( sOldPath, sNewPath )
        {
            if( ! forbidMultiSelect('renamed') )
                return;

            try
            {
                const params = new URLSearchParams({ old: sOldPath, new: sNewPath });

                // fetchIt() returns text on success, throws on HTTP error
                await fetchIt( API_FILES + '?' + params.toString(), { method: 'POST' });

                showNotification( 'Renamed successfully', 'is-success' );
                loadFileTree();
            }
            catch( error )
            {
                showNotification( 'Error renaming: ' + error.message, 'is-danger' );
            }
        }

        async function deleteResource( sPaths )
        {
            if( ! forbidMultiSelect('deleted') )
                return;

            try
            {
                const params = new URLSearchParams({ paths: sPaths });

                // fetchIt() returns text on success, throws on HTTP error
                await fetchIt( API_FILES + '?' + params.toString(), { method: 'DELETE' });

                showNotification( 'Deleted successfully', 'is-success' );
                loadFileTree();
            }
            catch( error )
            {
                showNotification( 'Error deleting: ' + error.message, 'is-danger' );
            }
        }

        //------------------------------------------------------------------------//
        // BUTTON ACTIONS

        function onUploadFile()
        {
            if( isFolder() || getSelected() === null || isRoot() )  document.getElementById( 'fileInput' ).click();
            else                                                    showNotification( 'Please select a folder or nothing to upload to root', 'is-warning' );
        }

        async function handleFileUpload( event )
        {
            const files = event.target.files;

            if( !files || files.length === 0 )
                return;

            const sParent  = getSelected() ? getSelectedPath() : '';
            const uploadButton = document.querySelector('.ti-upload').closest('button');

            // Visually indicate that an upload is in progress
            uploadButton.classList.add('is-loading');

            for (const file of files) {
                if (!isValidFileName(file.name)) {
                    // isValidFileName shows its own notification, so we just skip.
                    continue;
                }
                try {
                    // Sequentially upload each file as requested
                    await uploadFile( sParent, file );
                } catch (error) {
                    // Log the error and continue with the next file
                    console.error("Upload failed for file:", file.name, error);
                    // The notification is already shown by uploadFile, so we just log here.
                    // If one file fails, we stop to avoid unintended consequences
                    showNotification(`Upload failed for ${file.name}. Aborting further uploads.`, 'is-danger');
                    break; // Stop the loop on first failure
                }
            }

            // Clean up after all uploads are done or aborted
            event.target.value = ''; // Reset the file input
            uploadButton.classList.remove('is-loading');
        }

        /**
         * Uploads a file to the server using FormData.
         * @param {string|null} sParent - The directory ID or path.
         * @param {File} file - The file object from the input.
         * @returns {Promise<void>}
         */
        async function uploadFile( sParent, file )
        {
            // Check if file exists to prevent errors
            if( ! file )
            {
                showNotification('No file selected', 'is-warning');
                return;
            }

            try
            {
                // Use FormData for multipart/form-data upload
                const formData = new FormData();
                      formData.append('file', file);
                      formData.append('target', 'user_files');

                if( sParent )
                    formData.append('basedir', sParent);

                const response = await fetch('/gum/upload/',
                                                {
                                                    method: 'POST',
                                                    body: formData
                                                });

                if( ! response.ok )
                {
                    // Try to get JSON error first, fallback to text
                    let errorText;
                    try
                    {
                        const json = await response.json();
                        errorText = json.message || JSON.stringify(json);
                    }
                    catch( e )
                    {
                        errorText = await response.text();
                    }

                    throw new Error(`Failed to upload file. Server responded with ${response.status}: ${errorText}`);
                }

                showNotification('File uploaded successfully', 'is-success');

                if( typeof loadFileTree === 'function' )
                    loadFileTree();
            }
            catch( error )
            {
                showNotification('Error uploading file: ' + error.message, 'is-danger');
                throw error; // Re-throw to be caught by caller
            }
        }

        async function updateFileContent( sFilePath, sContent )
        {
            try
            {
                const params = new URLSearchParams({ file: sFilePath });
                const response = await fetch(API_FILES + '?' + params.toString(), {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'text/plain' // Specify content type for text
                    },
                    body: sContent
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to save file. Server responded with ${response.status}: ${errorText}`);
                }

                showNotification('File saved successfully', 'is-success');
                // No need to refresh tree here, as file name/structure hasn't changed.
                // loadFileTree(); // Uncomment if file creation/deletion should also happen here (not typical for 'save content')
            }
            catch (error)
            {
                showNotification('Error saving file: ' + error.message, 'is-danger');
                throw error;
            }
        }

        function onCreateFolder()
        {
            if( isFolder() || getSelected() === null || isRoot() )  openModal( 'modalCreateFolder' );
            else              showNotification( 'Please select a folder or nothing to create in root', 'is-warning' );
        }

        async function createFolder()
        {
            const sFolderName = document.getElementById( 'folderName' ).value.trim();

            if( ! isValidFileName( sFolderName ) )
                return;

            const sParent = getSelected() ? getSelectedPath() : '';

            await createResource( 'dir', sParent, sFolderName, null );

            closeModal( 'modalCreateFolder' );
            document.getElementById( 'folderName' ).value = '';
        }

        function onCreateFile()
        {
            if( isFolder() || getSelected() === null || isRoot() )  openModal( 'modalCreateFile' );
            else              showNotification( 'Please select a folder or nothing to create in root', 'is-warning' );
        }

        async function createFile()
        {
            const sFileName = document.getElementById( 'fileName' ).value.trim();

            if( ! isValidFileName( sFileName ) )
            {
                return;
            }

            const sParent = getSelected() ? getSelectedPath() : '';

            await createResource( 'file', sParent, sFileName, '' );

            closeModal( 'modalCreateFile' );
            document.getElementById( 'fileName' ).value = '';
        }

        function onRenameNode()
        {
            if( ! forbidMultiSelect('renamed') )
                return;

            if( isRoot() )
            {
                showNotification( 'Root node can not be renamed', 'is-warning' );
                return;
            }

            // Trigger jstree inline editing (equivalent to pressing F2)
            const selectedNode = getSelected();
            $('#fileTree').jstree( 'edit', selectedNode );
        }

        // Variables for rename tracking
        let originalRenameText = null;

        async function renameNode( sOldPath, sNewPath )
        {
            await renameResource( sOldPath, sNewPath );
        }

        async function onEditFile()
        {
            if( ! forbidMultiSelect('edited') )
                return;

            if( ! isFile() )
            {
                showNotification( 'Please select a file, not a folder', 'is-warning' );
                return;
            }

            const sFilePath = getSelectedPath();
            const ext = getFileExtension(sFilePath).toLowerCase();

            if( ! EDITABLE_EXTENSIONS.includes( ext ) )
            {
                showNotification('Only these file types can be edited: ' + EDITABLE_EXTENSIONS.join(', ') + '.<br>You can upload a new version to replace other file types.', 'is-info');
                return;
            }

            const sContent = await getFileContent( sFilePath );

            if( sContent !== null )
            {
                currentEditPath = sFilePath;
                document.getElementById( 'editFileName' ).textContent = getNodeName( sFilePath );
                document.getElementById( 'editorContent' ).value = sContent;
                openModal( 'modalEditFile' );
            }
        }

        async function saveFile()
        {
            const sContent = document.getElementById( 'editorContent' ).value;
            // currentEditPath already holds the full path of the file being edited
            await updateFileContent( currentEditPath, sContent );

            closeModal( 'modalEditFile' );
        }

        function onRefreshTree()
        {
            loadFileTree();
            showNotification( 'Tree refreshed', 'is-info' );
        }

        async function onDeleteNode()
        {
            if( ! forbidMultiSelect('deleted') )
                return;

            const itemName = getNodeName( getSelectedPath() );

            showConfirmDialog( 'Are you sure you want to delete "' + itemName + '"?', async ( confirmed ) =>
            {
                if( confirmed )
                    await deleteResource( getSelectedPath() );
            });
        }

        //------------------------------------------------------------------------//
        // UTILITY FUNCTIONS

        async function fetchIt( url, options = {}, retryCount = 0 )
        {
            const maxRetries = 2;
            const baseDelay  = 500;

            try
            {
                const response = await fetch( url, { ...options, timeout: 9000 } );

                if( ! response.ok )
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);

                const responseText = await response.text();

                if( ! responseText || ! responseText.trim() )
                    throw new Error('Empty response from server');

                return responseText;
            }
            catch( error )
            {
                if( retryCount < maxRetries &&
                    (error.message.includes('Empty response') ||
                     error.message.includes('Failed to fetch')) )
                {
                    const delay = baseDelay * Math.pow( 2, retryCount );
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchIt( url, options, retryCount + 1 );
                }

                throw error;
            }
        }

        function convertToJsTreeFormat( aData )
        {
            const aResult = [];
            const aItems = Array.isArray( aData ) ? aData : [ aData ];

            for( const item of aItems )
            {
                // Guard against null entries in the array
                if( ! item )
                    continue;

                const idClean  = item.path.replace(/[!"#$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&");  // Universal ID sanitizer for jstree/jQuery
                const isFolder = item.nodes !== null;

                // Logic: Extract the file/folder name from the relative path
                // e.g. "docs/manuals/index.html" -> "index.html"

                let sText = item.path;

                if( sText.indexOf( '/' ) !== -1 )
                    sText = sText.substring( sText.lastIndexOf( '/' ) + 1 );

                if( sText === '' )    // Handle root case (empty path)
                    sText = '/';

                const node ={
                                id    : idClean,
                                text  : sText,
                                icon  : getIconForPath( item.path, isFolder ),
                                path  : item.path,
                                isFile: ! isFolder
                            };

                // Recursive call: item.nodes is already an Array
                if( isFolder )
                    node.children = convertToJsTreeFormat( item.nodes );

                aResult.push( node );
            }

            return aResult;
        }

        function getIconForPath( sPath, isFolder )
        {
            if( isFolder )
                return 'ti ti-folder';

            switch( getFileExtension( sPath ).toLowerCase() )
            {
                case 'md'  : return 'ti ti-markdown';
                case 'pdf' : return 'ti ti-file-type-pdf';
                case 'doc' :
                case 'docx': return 'ti ti-file-word';
                case 'xls' :
                case 'xlsx': return 'ti ti-file-spreadsheet';
                case 'ppt' :
                case 'pptx': return 'ti ti-presentation';
                case 'jpg' :
                case 'jpeg':
                case 'png' :
                case 'gif' :
                case 'svg' : return 'ti ti-photo';
                case 'zip' :
                case 'rar' :
                case '7z'  : return 'ti ti-file-zip';
                case 'html': return 'ti ti-brand-html5';
                case 'css' : return 'ti ti-brand-css3';
                case 'xml' : return 'ti ti-file-type-xml';
                case 'js'  :
                case 'json':
                case 'java':
                case 'py'  :
                case 'cpp' :
                case 'c'   :
                case 'h'   : return 'ti ti-code';
                default:
                             return 'ti ti-file';
            }
        }

        function getFileExtension( sPath )
        {
            const nDotIndex = sPath.lastIndexOf( '.' );

            if( nDotIndex === -1 || nDotIndex === sPath.length - 1 )
                return '';

            return sPath.substring( nDotIndex + 1 );
        }

        function getNodeName( sPath )
        {
            const nSlashIndex = sPath.lastIndexOf( '/' );

            if( nSlashIndex === -1 )
                return sPath;

            return sPath.substring( nSlashIndex + 1 );
        }

        function getParentPath( sPath )
        {
            const nSlashIndex = sPath.lastIndexOf( '/' );

            if( nSlashIndex === -1 )
                return '';

            return sPath.substring( 0, nSlashIndex );
        }

        function getSelected()
        {
            if( Array.isArray( aSelected ) && aSelected.length > 0 )
                return aSelected[0];

            return null;
        }

        function getSelectedPath()
        {
            return getSelected().original.path;
        }

        function isRoot( node = getSelected() )
        {
            if( node && ! node.path )
                node = node.original;

            return node             &&
                   node.path === '' &&
                   node.text === '/';
        }

        function isFile( node = getSelected() )
        {
            if( node && ! node.isFile )
                node = node.original;

            return node && node.isFile;
        }

        function isFolder( node = getSelected() )
        {
            return ! isFile( node );
        }

        function isValidFileName( name )
        {
            if( ! name || name.trim() === '' ) {
                showNotification( 'Name cannot be empty', 'is-warning' );
                return false;
            }
            // Basic validation for common invalid characters in file paths (e.g., /, \, :, *, ?, ", <, >, |)
            const invalidChars = /[\\/:\*\?"<>|\x00-\x1f]/; // Also includes control characters
            if( invalidChars.test( name ) ) {
                showNotification( 'Name contains invalid characters (e.g., \\ / : * ? " < > |)', 'is-warning' );
                return false;
            }
            if( name.length > 255 ) { // Common OS limit for file names
                showNotification( 'Name is too long (max 255 characters)', 'is-warning' );
                return false;
            }
            // Prevent names that are just dots (e.g., ".", "..") which can have special meanings
            if( name === '.' || name === '..' ) {
                 showNotification( 'Name cannot be "." or ".."', 'is-warning' );
                 return false;
            }
            return true;
        }

        function forbidMultiSelect( action )
        {
            if( Array.isArray( aSelected ) && aSelected.length > 1 )
            {
                showNotification( "Only one node can be "+ action +" at a time", "is-warning" );
                return false;
            }

            return true;
        }

        //------------------------------------------------------------------------//
        // MODAL FUNCTIONS

        function openModal( sModalId )
        {
            document.getElementById( sModalId ).classList.add( 'is-active' );
        }

        function closeModal( sModalId )
        {
            document.getElementById( sModalId ).classList.remove( 'is-active' );
        }

        let confirmCallback = null; // Global to store the callback for confirm modal

        function showConfirmDialog( message, onConfirm )
        {
            document.getElementById( 'confirmMessage' ).innerHTML = message;
            confirmCallback = onConfirm;
            openModal( 'modalConfirm' );

            // Remove existing listeners to prevent multiple bindings
            const yesButton = document.getElementById( 'confirmYes' );
            const noButton  = document.getElementById( 'confirmNo' );

            yesButton.onclick = () => {
                closeModal( 'modalConfirm' );
                if (confirmCallback) {
                    confirmCallback(true);
                }
            };
            noButton.onclick = () => {
                closeModal( 'modalConfirm' );
                if (confirmCallback) {
                    confirmCallback(false);
                }
            };

            // Focus on the Yes button for keyboard support
            yesButton.focus();

            // Add keyboard support for confirm dialog (Esc to cancel)
            const handleConfirmKeyDown = (e) => {
                if( e.key === 'Escape' ) {
                    e.preventDefault();
                    closeModal( 'modalConfirm' );
                    if (confirmCallback) {
                        confirmCallback(false);
                    }
                }
            };

            yesButton.addEventListener('keydown', handleConfirmKeyDown);
            noButton.addEventListener('keydown', handleConfirmKeyDown);
        }

        //------------------------------------------------------------------------//
        // NOTIFICATION

        function showNotification( sMessage, sType )
        {
            const div = document.createElement( 'div' );
                  div.className = 'notification ' + sType;
                  div.style.position = 'fixed';
                  div.style.top = '20px';
                  div.style.right = '20px';
                  div.style.zIndex = '9999';
                  div.style.minWidth = '300px';
                  div.innerHTML = '<button class="delete"></button>' + sMessage;

                  div.querySelector( '.delete' ).onclick = () => div.remove();

            document.body.appendChild( div );

            let time = parseInt( sMessage.length / 14 );
                time = Math.max( 2, time ) * 1000;

            setTimeout( () =>  div.remove(), time );
        }
    </script>
</body>
</html>